#!/bin/bash  
  
  
nmap=/usr/bin/nmap  
params="-sV"  
tmp_file=/tmp/nmap_scanner_output  
output=resultados.csv  
export SCANNER_ERROR=0  
  
echo "host,IP,Servicio,Puerto,Version" >> $output  
for ips in ips.*  
do  
    echo "Analizando $ips ..."  
    for ip in $(cat $ips)  
    do  
        echo -e "\t-> $ip ..."  
        ping -c 1 $ip 1>/dev/null 2>&1|| export SCANNER_ERROR=1  
        if [ $SCANNER_ERROR = "1" ]; then  
            echo -e "\t\t- Host no activo"  
        fi  
        if [ $SCANNER_ERROR = "0" ]; then  
            $nmap $params $ip |grep -v "Starting Nmap" |grep -v "Nmap scan report" |grep -v "Host is up" |grep -v "Not shown" |grep -v "Service detection performed" |grep -v "Nmap done" > $tmp_file  
            export _host=$(grep "Service Info" $tmp_file |sed 's/,//g'|grep "Host" |awk -F ' ' {'print $4'} |sed 's/;//g')  
            grep tcp $tmp_file |scanner_ip=$ip awk -F " " '{print ENVIRON["_host"]","ENVIRON["scanner_ip"]","$3","$1","$4,$5,$6,$7,$8;}' >>$output  
            echo -e "\n" >>$output  
        fi  
        export SCANNER_ERROR=0  
    done  
done 
